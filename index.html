<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Admin - จัดการสินค้า</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- Mobile-First Dark Theme --- */
        :root {
            --bg-main: #000000; --bg-card: #1a1a1a; --bg-input: #2a2a2a;
            --text: #ffffff; --text-muted: #888888;
            --orange: #ff5722; --danger: #e74c3c; --success: #2ecc71;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Kanit', sans-serif; background: var(--bg-main); color: var(--text);
            padding: 15px; padding-bottom: 50px; /* เผื่อพื้นที่ด้านล่าง */
        }
        h2 { text-align: center; margin-bottom: 20px; color: var(--orange); font-size: 1.4rem; font-weight: 600; }
        
        /* --- Form Styles (Mobile Optimized) --- */
        .form-container {
            background: var(--bg-card); padding: 20px 15px; border-radius: 16px;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .form-mode-badge {
            display: inline-block; background: var(--orange); color: white;
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 15px;
        }
        .edit-mode-active .form-mode-badge { background: var(--success); }

        label { display: block; margin-bottom: 8px; font-size: 0.95rem; color: var(--text-muted); }
        /* Input ใหญ่ขึ้น กดง่ายบนมือถือ */
        input, select, textarea {
            width: 100%; padding: 14px; margin-bottom: 18px; border-radius: 12px;
            border: 1px solid var(--bg-input); background: var(--bg-input);
            color: var(--text); font-family: 'Kanit'; font-size: 1rem; outline: none;
            appearance: none; /* ลบสไตล์ default ของมือถือ */
        }
        input:focus, select:focus, textarea:focus { border-color: var(--orange); background: #333; }
        textarea { height: 100px; resize: none; }

        /* ปุ่มใหญ่ๆ เต็มจอ */
        .btn-submit {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: var(--orange); color: white; font-size: 1.1rem; font-weight: 600;
            cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit.edit-mode { background: var(--success); }
        .btn-cancel {
            width: 100%; padding: 14px; margin-top: 10px; background: transparent;
            color: var(--text-muted); border: 2px solid var(--bg-input); border-radius: 12px;
            cursor: pointer; font-size: 1rem; display: none; /* ซ่อนไว้ก่อน */
        }

        /* --- List Section (Card View for Mobile) --- */
        .list-container { margin-top: 30px; }
        .list-header { font-size: 1.2rem; margin-bottom: 15px; padding-left: 5px; border-left: 4px solid var(--orange); }
        
        .product-item-card {
            background: var(--bg-card); padding: 15px; border-radius: 12px;
            margin-bottom: 12px; display: flex; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .prod-thumb {
            width: 60px; height: 60px; object-fit: cover; border-radius: 8px;
            margin-right: 15px; flex-shrink: 0; background: #333;
        }
        .prod-details { flex-grow: 1; overflow: hidden; }
        .prod-name { font-size: 1rem; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .prod-category { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;}
        .prod-category i { font-size: 0.7rem; color: var(--orange); }

        .prod-actions { flex-shrink: 0; display: flex; gap: 8px; margin-left: 10px;}
        .action-btn {
            width: 36px; height: 36px; border: none; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1rem; color: white;
        }
        .btn-edit-card { background: rgba(46, 204, 113, 0.2); color: var(--success); }
        .btn-delete-card { background: rgba(231, 76, 60, 0.2); color: var(--danger); }

        /* Status & Loading */
        #statusMessage { text-align: center; margin-bottom: 20px; min-height: 1.4em; font-weight: 500;}
        .success-msg { color: var(--success); } .error-msg { color: var(--danger); }
        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; color: white; font-size: 1.2rem; backdrop-filter: blur(5px);}
        .loading-spinner { font-size: 2.5rem; color: var(--orange); margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loadingOverlay">
        <i class="fas fa-circle-notch fa-spin loading-spinner"></i>
        <span>กำลังประมวลผล...</span>
    </div>

    <h2><i class="fas fa-mobile-alt"></i> Mobile Admin</h2>
    <div id="statusMessage"></div>

    <div class="form-container" id="formContainer">
        <div id="formModeBadge" class="form-mode-badge">โหมด: เพิ่มสินค้าใหม่</div>
        
        <form id="productForm">
            <input type="hidden" id="action" name="action" value="add">
            <input type="hidden" id="productId" name="id" value="">
            <label>ชื่อสินค้า *</label>
            <input type="text" id="name" name="name" required placeholder="... เช่น หูฟังบลูทูธ">
            
            <label>หมวดหมู่ *</label>
            <select id="category" name="category" required>
                <option value="">-- แตะเพื่อเลือก --</option>
                <option value="ของใช้ในครัว">ของใช้ในครัว</option>
                <option value="อุปกรณ์ทำความสะอาด">อุปกรณ์ทำความสะอาด</option>
                <option value="ของแต่งบ้าน">ของแต่งบ้าน</option>
                <option value="เครื่องใช้ไฟฟ้า">เครื่องใช้ไฟฟ้า</option>
                <option value="เสื้อผ้า">เสื้อผ้า</option>
                <option value="ของใช้ในบ้าน">ของใช้ในบ้าน</option>
                <option value="อุปกรณ์อิเล็กทรอนิกส์">อุปกรณ์อิเล็กทรอนิกส์</option>
                <option value="Gadget">Gadget</option>
                <option value="อาหาร">อาหาร</option>
                <option value="เครื่องสำอาง">เครื่องสำอาง</option>
                <option value="อื่นๆ">อื่นๆ</option>
            </select>

            <label>ราคา (เฉพาะตัวเลข)</label>
            <input type="number" id="price" name="price" placeholder="... เช่น 590">

            <label>ลิงก์ร้านค้า *</label>
            <input type="url" id="link" name="link" required placeholder="https://...">

            <label>ลิงก์รูปภาพ *</label>
            <input type="url" id="image" name="image" required placeholder="https://...">

            <label>รายละเอียดเพิ่มเติม</label>
            <textarea id="description" name="description" placeholder="..."></textarea>

            <button type="submit" class="btn-submit" id="submitBtn">
                <i class="fas fa-plus-circle"></i> <span>เพิ่มสินค้า</span>
            </button>
            <button type="button" class="btn-cancel" id="cancelBtn" onclick="resetForm()">ยกเลิก / เคลียร์ฟอร์ม</button>
        </form>
    </div>

    <div class="list-container">
        <h3 class="list-header">รายการสินค้าทั้งหมด</h3>
        <div id="productListContent">
            </div>
    </div>

    <script>
        // ======================================================
        // ⚠️⚠️⚠️ วาง URL Web App ของคุณที่นี่ ⚠️⚠️⚠️
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzoEFcaMRt27hTwd6_3I46L-QBrNBGAuB2l8wNBw2HI3zuADkLal9l3LNS_Hl_1DGsnCA/exec";
        // ======================================================

        const form = document.getElementById('productForm');
        const statusMsg = document.getElementById('statusMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const productListContent = document.getElementById('productListContent');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const formModeBadge = document.getElementById('formModeBadge');
        const formContainer = document.getElementById('formContainer');
        let allProductsCache = [];

        window.onload = loadProducts;

        function loadProducts() {
            loadingOverlay.style.display = 'flex';
            fetch(GOOGLE_SCRIPT_URL)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        allProductsCache = data.data;
                        renderList(allProductsCache.slice().reverse());
                    }
                })
                .catch(err => {
                    console.error(err);
                    statusMsg.innerHTML = `<span class="error-msg">❌ โหลดข้อมูลไม่สำเร็จ (เช็คเน็ต/URL)</span>`;
                })
                .finally(() => loadingOverlay.style.display = 'none');
        }

        // --- แสดงผลแบบ Card View (สำหรับมือถือ) ---
        function renderList(products) {
            productListContent.innerHTML = '';
            if (products.length === 0) {
                productListContent.innerHTML = '<p style="text-align:center; color:#666;">ยังไม่มีสินค้า</p>';
                return;
            }
            products.forEach(row => {
                // row[0]=ID, row[1]=Name, row[3]=Image, row[4]=Category
                const card = document.createElement('div');
                card.className = 'product-item-card';
                card.innerHTML = `
                    <img src="${row[3]}" class="prod-thumb" onerror="this.src='https://via.placeholder.com/60x60?text=No+Img'">
                    <div class="prod-details">
                        <div class="prod-name">${row[1]}</div>
                        <div class="prod-category"><i class="fas fa-tag"></i> ${row[4]}</div>
                    </div>
                    <div class="prod-actions">
                        <button class="action-btn btn-edit-card" onclick="startEditMode('${row[0]}')"><i class="fas fa-pen"></i></button>
                        <button class="action-btn btn-delete-card" onclick="confirmAction('delete', '${row[0]}', '${row[1]}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                productListContent.appendChild(card);
            });
        }

        function startEditMode(id) {
            const productData = allProductsCache.find(row => row[0].toString() === id.toString());
            if (!productData) return;

            document.getElementById('action').value = 'edit';
            document.getElementById('productId').value = productData[0];
            document.getElementById('name').value = productData[1];
            document.getElementById('link').value = productData[2];
            document.getElementById('image').value = productData[3];
            document.getElementById('category').value = productData[4];
            document.getElementById('price').value = productData[5];
            document.getElementById('description').value = productData[7];

            submitBtn.innerHTML = '<i class="fas fa-save"></i> <span>บันทึกการแก้ไข</span>';
            submitBtn.classList.add('edit-mode');
            formContainer.classList.add('edit-mode-active');
            cancelBtn.style.display = 'block';
            formModeBadge.innerText = `กำลังแก้ไข: ${productData[1].substring(0, 15)}...`;
            
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            statusMsg.innerText = '';
        }

        function resetForm() {
            form.reset();
            document.getElementById('action').value = 'add';
            document.getElementById('productId').value = '';
            submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> <span>เพิ่มสินค้า</span>';
            submitBtn.classList.remove('edit-mode');
            formContainer.classList.remove('edit-mode-active');
            cancelBtn.style.display = 'none';
            formModeBadge.innerText = 'โหมด: เพิ่มสินค้าใหม่';
        }

        // --- ฟังก์ชันใหม่: จัดการการกดปุ่ม Submit และถามรหัสผ่าน ---
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // หยุดการส่งฟอร์มปกติ
            const currentAction = document.getElementById('action').value;
            const productName = document.getElementById('name').value;
            
            // เรียกใช้ฟังก์ชันยืนยัน (ซึ่งจะถามรหัสผ่าน)
            confirmAction(currentAction, null, productName);
        });

        // --- ฟังก์ชันยืนยันการกระทำ (ถามรหัสผ่านที่นี่!) ---
        function confirmAction(actionType, id, name) {
            let actionText = actionType === 'add' ? 'เพิ่มสินค้า' : (actionType === 'edit' ? 'บันทึกการแก้ไข' : 'ลบสินค้า');
            
            // ถามรหัสผ่าน (Prompt)
            const password = prompt(`กรุณาใส่รหัสผ่าน Admin เพื่อยืนยันการ "${actionText}":\n(${name})`);
            
            // ถ้ารหัสผ่านไม่ว่างเปล่า (กด OK และมีข้อความ) ให้ดำเนินการต่อ
            if (password !== null && password.trim() !== '') {
                if (actionType === 'delete') {
                    sendDataToBackend({ action: 'delete', id: id, password: password });
                } else {
                    // ถ้าเป็น Add หรือ Edit ให้ดึงข้อมูลจากฟอร์มมาเติมรหัสผ่าน
                    const formData = new FormData(form);
                    const data = {};
                    formData.forEach((value, key) => data[key] = value);
                    data.password = password; // เพิ่มรหัสผ่านเข้าไปในข้อมูลที่จะส่ง
                    sendDataToBackend(data);
                }
            }
             // ถ้ากด Cancel หรือไม่ใส่รหัส ก็ไม่ต้องทำอะไร
        }


        function sendDataToBackend(dataObj) {
            loadingOverlay.style.display = 'flex';
            statusMsg.innerText = '';

            const params = new URLSearchParams();
            for (const key in dataObj) { params.append(key, dataObj[key]); }

            fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', body: params, redirect: 'follow'
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    statusMsg.innerHTML = `<span class="success-msg">✅ ${data.message}</span>`;
                    if (data.action === 'add' || data.action === 'edit') {
                        resetForm();
                    }
                    loadProducts();
                } else {
                    statusMsg.innerHTML = `<span class="error-msg">❌ ${data.message}</span>`;
                }
            })
            .catch(err => {
                statusMsg.innerHTML = `<span class="error-msg">❌ เชื่อมต่อล้มเหลว</span>`;
                console.error(err);
            })
            .finally(() => loadingOverlay.style.display = 'none');
        }
    </script>
</body>
</html>

